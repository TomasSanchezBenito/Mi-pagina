<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 40px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 { margin-top: 0; }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0 20px;
      box-sizing: border-box;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .footer {
      margin-top: 20px;
      font-size: 12px;
      color: gray;
      text-align: center;
    }
    .popup {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      max-width: 600px;
      margin: auto;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }
    .popup button:hover {
      background-color: #218838;
    }
    button:disabled {
      background-color: #ccc;
      cursor: default;
    }
    button:disabled:hover {
      background-color: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Generador de Test en HTML</h1>
    <label for="file">Sube tu archivo .txt con preguntas:</label>
    <input type="file" id="file" accept=".txt">
    <label for="titulo">T√≠tulo del test:</label>
    <input type="text" id="titulo" placeholder="Ej: Test de Normativa">
    <label for="nombreArchivo">Nombre del archivo de salida (.html):</label>
    <input type="text" id="nombreArchivo" placeholder="Ej: test_normativa.html">
    <button id="btnGenerar" onclick="procesarArchivo()" disabled>Generar</button>
    <div class="footer">2025</div>
  </div>

  <div class="popup" id="popupAviso">
    <span>‚ö†Ô∏è P√°gina de prueba, es posible que se almacenen los datos que se introduzcan.</span>
    <button onclick="aceptarAviso()">Aceptar</button>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.3/+esm" type="module"></script>

  <!-- L√≥gica principal -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.3/+esm";

    const supabase = createClient(
      'https://<TU-PROYECTO>.supabase.co',  // üîÅ Reemplaza
      'tu-anon-key'                         // üîÅ Reemplaza
    );

    function aceptarAviso() {
      document.getElementById('popupAviso').style.display = 'none';
      document.getElementById('btnGenerar').disabled = false;
    }

    function parsearPreguntas(texto) {
      const lineas = texto.split(/\r?\n/);
      const preguntas = [];
      let preguntaActual = null;

      lineas.forEach(linea => {
        linea = linea.trim();
        if (!linea) return;

        if (linea.startsWith('#')) {
          if (preguntaActual) preguntas.push(preguntaActual);
          preguntaActual = { pregunta: linea.slice(1).trim(), opciones: [], correcta: -1 };
        } else if (/^(\*?[a-d]\))/.test(linea)) {
          const esCorrecta = linea.startsWith('*');
          const cleanLine = esCorrecta ? linea.slice(1).trim() : linea;
          const textoOpcion = cleanLine.slice(2).trim();
          if (preguntaActual) {
            const idx = preguntaActual.opciones.length;
            preguntaActual.opciones.push(textoOpcion);
            if (esCorrecta) preguntaActual.correcta = idx;
          }
        }
      });

      if (preguntaActual) preguntas.push(preguntaActual);
      return preguntas;
    }

    function generarHTML(preguntas, titulo) {
      const preguntasJS = JSON.stringify(preguntas, null, 2);
      return `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${titulo}</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .option { margin: 10px 0; padding: 12px; border: 2px solid #ccc; border-radius: 8px; cursor: pointer; }
    .option.selected { border-color: #007bff; background-color: #e7f0fe; }
    .option.correct { background-color: #d4edda; border-color: #28a745; }
    .option.incorrect { background-color: #f8d7da; border-color: #dc3545; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
<div class="container">
  <h1>${titulo}</h1>
  <div id="quiz">
    <div id="progress" style="margin-bottom:10px; font-size:14px; color: #666;"></div>
    <div id="question" style="font-weight:bold;"></div>
    <div id="options"></div>
    <button id="check-button">Comprobar</button>
    <button id="next-button" style="display:none;">Siguiente</button>
    <div id="results" style="margin-top:20px; font-weight:bold;"></div>
  </div>
</div>
<script>
const preguntas = ${preguntasJS};
let current = 0;
let correctas = 0;
let selected = null;

const questionDiv = document.getElementById('question');
const optionsDiv = document.getElementById('options');
const checkBtn = document.getElementById('check-button');
const nextBtn = document.getElementById('next-button');
const results = document.getElementById('results');

function mostrarPregunta() {
  selected = null;
  const p = preguntas[current];
  document.getElementById('progress').textContent = 'Pregunta ' + (current + 1) + ' de ' + preguntas.length;
  questionDiv.textContent = p.pregunta;
  optionsDiv.innerHTML = '';
  p.opciones.forEach((opcion, idx) => {
    const div = document.createElement('div');
    div.className = 'option';
    div.textContent = String.fromCharCode(97 + idx) + ') ' + opcion;
    div.dataset.idx = idx;
    div.onclick = () => {
      document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
      div.classList.add('selected');
      selected = div;
    };
    optionsDiv.appendChild(div);
  });
  checkBtn.style.display = 'inline-block';
  nextBtn.style.display = 'none';
  results.textContent = '';
}
checkBtn.onclick = () => {
  if (!selected) return alert("Selecciona una opci√≥n.");
  const idx = parseInt(selected.dataset.idx);
  const correcta = preguntas[current].correcta;
  if (idx === correcta) {
    selected.classList.add('correct');
    correctas++;
  } else {
    selected.classList.add('incorrect');
    document.querySelectorAll('.option')[correcta].classList.add('correct');
  }
  checkBtn.style.display = 'none';
  nextBtn.style.display = 'inline-block';
};
nextBtn.onclick = () => {
  current++;
  if (current < preguntas.length) {
    mostrarPregunta();
  } else {
    questionDiv.textContent = 'Test finalizado';
    optionsDiv.innerHTML = '';
    checkBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    results.textContent = 'Correctas: ' + correctas + ' de ' + preguntas.length;
  }
};
mostrarPregunta();
</script>
</body>
</html>`;
    }

    async function procesarArchivo() {
      const archivo = document.getElementById('file').files[0];
      const titulo = document.getElementById('titulo').value.trim();
      let nombre = document.getElementById('nombreArchivo').value.trim();

      if (!archivo) return alert("Sube un archivo .txt.");
      if (!titulo) return alert("Escribe un t√≠tulo.");
      if (!nombre) return alert("Escribe un nombre de archivo.");
      if (!nombre.endsWith(".html")) nombre += ".html";

      // üîÅ SUBIR .TXT ORIGINAL A SUPABASE
      const { data: subida, error: errorSubida } = await supabase.storage
        .from('test-files')  // <-- Cambia si tu bucket tiene otro nombre
        .upload(`uploads/${archivo.name}`, archivo, { upsert: true });

      if (errorSubida) {
        console.error("Error subiendo archivo .txt:", errorSubida);
        alert("‚ùå No se pudo subir el archivo .txt.");
      } else {
        console.log("‚úÖ Archivo .txt subido correctamente:", subida.path);
      }

      const lector = new FileReader();
      lector.onload = function (e) {
        const contenido = e.target.result;
        const preguntas = parsearPreguntas(contenido);

        if (!preguntas.length) {
          alert("No se detectaron preguntas v√°lidas.");
          return;
        }

        const html = generarHTML(preguntas, titulo);
        descargarArchivo(html, nombre);
      };
      lector.readAsText(archivo, 'UTF-8');
    }

    function descargarArchivo(contenido, nombre) {
      const blob = new Blob([contenido], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nombre;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
